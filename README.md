# Cassandra Snapshot Tools 

A handy couple of scripts that make creating, moving, and restoring SSTable snapshots between clusters easy.  Some common use cases include:
* Copying keyspaces between clusters (QA environments, for example)
* Staging an upgrade (application, Cassandra, both) using a copy of live data
* Seeding data in a test environment
* Snapshotting a keyspace for offline analytics
* Backup and restore
* Generally moving a keyspace from one Cassandra cluster to another

Cassandra Snapshot Tools currently includes multiple BASH shell scripts which leverage standard Cassandra utilities like `nodetool`, `cqlsh` to simplify the process of creating snapshots and moving them between hosts.  A convenient compressed tar archive is generated by `localDataBackup.sh`, and includes all of the SSTable snapshot files, metadata, and schema information necessary to restore the keyspace into another Cassandra cluster (or the same cluster).  The `localDataRestore.sh` tool is then used to restore data into an empty Cassandra node with the given table structure.

You can as well use a Swift object storage to store directly all of the SSTable snapshot files, metadata, and schema information into a bucket, without compressing them into a tar, using `swiftDataBackup.sh`, and restore that data into an empty Cassandra node with the given table structure with `swiftDataRestore.sh`.

### Features
* Automatically generates a keyspace snapshot and packages into an easy-to-move archive
* Copies snapshots out of the Cassandra data directory, space is reclaimed using `nodetool clearsnapshot`
* Schedulable using Cron (e.g. for scheduled backups)
* Easy to use with sane defaults
* Tested on Cassandra 3.11

### Usage
#### localDataBackup.sh

    Usage: ./localDataBackup.sh -h
           ./localDataBackup.sh -k <keyspace name> [-s <snapshot name>] [-y <cassandra.yaml file>] [--no-timestamp]
        -h,--help                          Print usage and exit
        -v,--version                       Print version information and exit
        -k,--keyspace <keyspace name>      REQUIRED: The name of the keyspace to snapshot
        -s,--snapshot <snapshot name>      REQUIRED: The name of an existing snapshot to package
        -y,--yaml <cassandra.yaml file>    Alternate cassandra.yaml file

#### localDataRestore

    Usage : 
        ./localDataRestore.sh SNAPSHOT_TAR KEYSPACE
            KEYSPACE: the keyspace where to restore all data
            SNAPSHOT_TAR: the snapshot tarball to restore data from

#### truncateAll

    Usage: ./truncateAll.sh -h
           ./truncateAll.sh [-k <keyspace name> ...] [-t <keyspace_name.table_name> ...]
        -h,--help                          Print usage and exit
        -k,--keyspace <keyspace name>           The keyspace where to drop all data (can drop multiple keyspaces)
        -t,--table <keyspace_name.table_name>   Single table to drop data (can drop multiple tables)

    Note: You need at least to pass as a parameter a keyspace or a table to backup!

#### dataSwift

    Usage: ./dataSwift.sh command [options]

    Commands:
    upload - upload file to Swift
    download - download file from Swift

    Options:
    -h,--help                          Print usage and exit
    -b,--bucket <switf_container>      REQUIRED: The bucket in Swift where the file will be stored/downloaded
    -f,--file <file>                   REQUIRED: The file to upload/download

    Notes:
    * You need to have swift client installed and be authenticated to your object storage first

#### swiftDataBackup

    Usage: ./swiftDataBackup.sh -h
           ./swiftDataBackup.sh -b <bucket_name> [-k <keyspace_name> ...] [-t <keyspace_name.table_name> ...] [-y <cassandra.yaml file>]
        -h,--help                               Print usage and exit
        -v,--version                            Print version information and exit
        -b,--bucket <bucket_name>               REQUIRED: The bucket name where the snapshot will be stored
        -k,--keyspace <keyspace_name>           The name of the keyspace to snapshot (can add multiple keyspaces)
        -t,--table <keyspace_name.table_name>   Single table to backup (can add multiple tables)
        -y,--yaml <cassandra.yaml file>         Alternate cassandra.yaml file

        Note: You need at least to pass as a parameter a keyspace or a table to backup!

#### swiftDataRestore

    Usage: ./swiftDataRestore.sh -h
           ./swiftDataRestore.sh -b <bucket_name> [-k <keyspace_name> ...] [-t <keyspace_name.table_name> ...]
        -h,--help                                 Print usage and exit
        -b,--bucket <bucket_name>                 REQUIRED: The bucket name where the snapshot is stored on swift
        -k,--keyspace <keyspace_name>             The keyspace where to restore the data (can restore multiple keyspaces)
        -t,--table <keyspace_name.table_name>     Single table to restore data (can restore multiple tables)

        Note: You need at least to pass as a parameter a keyspace or a table to backup!

### Basic Examples

1. Backup, clear then restore locally:

    ```sh
    $ ./localDataBackup.sh -k <keyspace name> -s <snapshot name>
    $ ./truncateAll.sh <keyspace name> 
    $ ./localDataRestore.sh <snapshot package file> <new keyspace name>
    ```

2. Backup, clear then restore using a Swift object storage:

    ```sh
    $ ./swiftDataBackup.sh -k <keyspace name> -b <bucket name>
    $ ./truncateAll.sh <keyspace name> 
    $ ./swiftDataRestore.sh -k <keyspace name> -b <bucket name>
    ```

**Note**: you need to have swift client installed and your authentication configured by setting up variables in your environment (see `resources/object-storage.conf.swift.sample`)

### Caveats
* Currently supports snapshots/restores between clusters running similar versions of Cassandra.
* Local access to the source Cassandra node is required (to create/collect snapshot files).  Fairly open network access is required to the destination Cassandra node (to create the schema and load SSTables).

### Contributing
All contributions welcome!  Please see [How to Contribute](CONTRIBUTING.md).

### Credit

This work is copied from https://github.com/AppliedInfrastructure/cassandra-snapshot-tools
